# Production deployment for Raspberry Pi
# Auto-updates enabled via Watchtower
#
# Usage (Docker named volumes):
#   docker-compose -f docker-compose.prod.yml --profile default up -d
#
# Usage (local bind mounts for easy backup access):
#   docker-compose -f docker-compose.prod.yml --profile local up -d
#   Optionally set DATA_PATH and LOGS_PATH in .env to customize paths
#
# With Cloudflare Tunnel (combine with either):
#   docker-compose -f docker-compose.prod.yml --profile default --profile tunnel up -d
#   docker-compose -f docker-compose.prod.yml --profile local --profile tunnel up -d
#   (requires CLOUDFLARE_TUNNEL_TOKEN in .env)

x-chronoflow-common: &chronoflow-common
  image: ghcr.io/${GITHUB_REPO:-ajaykumarkannan/timetracker}:latest
  ports:
    - "${HOST_PORT:-4849}:4849"
  environment:
    - NODE_ENV=production
    - PORT=4849
    - DB_PATH=/app/data/timetracker.db
    # MongoDB option
    # - DB_DRIVER=mongo
    # - MONGO_URI=mongodb://chronoflow-mongo:27017
    # - MONGO_DB=chronoflow
    - TRUST_PROXY=true
    - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
    - CORS_ORIGIN=${CORS_ORIGIN:-*}
    - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
  restart: unless-stopped
  deploy:
    resources:
      limits:
        memory: 256M
      reservations:
        memory: 128M
  healthcheck:
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4849/api/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  labels:
    - "com.centurylinklabs.watchtower.enable=true"
  networks:
    - chronoflow-net

services:
  # Default: Docker named volumes (no profile needed)
  chronoflow:
    <<: *chronoflow-common
    container_name: chronoflow
    profiles:
      - default
    volumes:
      - chronoflow-data:/app/data
      - chronoflow-logs:/app/logs

  # Alternative: Local bind mounts (--profile local)
  chronoflow-local:
    <<: *chronoflow-common
    container_name: chronoflow-local
    profiles:
      - local
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ${LOGS_PATH:-./logs}:/app/logs

  chronoflow-mongo:
    image: mongo:7
    container_name: chronoflow-mongo
    profiles:
      - mongo
    ports:
      - "27017:27017"
    volumes:
      - chronoflow-mongo-data:/data/db
    restart: unless-stopped
    networks:
      - chronoflow-net

  # Cloudflare Tunnel (enable with: --profile tunnel)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    profiles:
      - tunnel
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
    restart: unless-stopped
    networks:
      - chronoflow-net

  # Watchtower - automatically updates containers when new images are pushed
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_API_VERSION=1.44
      - WATCHTOWER_POLL_INTERVAL=3600
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_CLEANUP=true
    restart: unless-stopped

networks:
  chronoflow-net:
    driver: bridge

volumes:
  chronoflow-data:
  chronoflow-logs:
  chronoflow-mongo-data:
